<!doctype html>
<head>
	<title>Vivid Frontend</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.light_blue-indigo.min.css">
	<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<link rel="stylesheet" href="ttk.css" type="text/css">
	<script src="https://cdn.jsdelivr.net/gh/Kirschn/mastodon.js@master/mastodon.js"></script>
	<meta charset="UTF-16">
</head>
<body>
	<script>
		var api = new MastodonAPI({
			instance: localStorage.getItem('mastodon_instance'),
			api_user_token: ""
		});
		if (window.location.href.indexOf("?code=") !== -1) {
				// nice, we got our auth code!
				// lets put it into a variable
				var authCode = window.location.href.replace(window.location.origin + window.location.pathname + "?code=", "");
				// nice variable clusterfuck, eh?
				// we have everything needed to access our oauth token
				api.getAccessTokenFromAuthCode(
						localStorage.getItem("mastodon_client_id"),
						localStorage.getItem("mastodon_client_secret"),
						localStorage.getItem("mastodon_client_redirect_uri"),
						authCode,
						function(data) {
								// AAAND DATA CONTAINS OUR TOKEN!
								api.setConfig("api_user_token", data.access_token) //to set it without having to reinit the entire
								// library.
								console.info(data);
								localStorage.setItem("mastodon_token", data.access_token);
						}
				)
		}
		if (window.location.href.indexOf("?getcd") !== -1) {
			api.registerApplication("Vivid frontend",
				"https://bleonard252.github.io/vivid-fe/index.html", // redirect uri, we will need this later on
                ["read", "write", "follow"], //scopes
                "https://bleonard252.github.io/vivid-fe/index.html", //website on the login screen
                function(data) {
                    // we got our application
                    // lets save it to our browser storage
                    localStorage.setItem("mastodon_client_id", data["client_id"]);
                    localStorage.setItem("mastodon_client_secret", data["client_secret"]);
                    localStorage.setItem("mastodon_client_redirect_uri", data["redirect_uri"]);
                    // now, that we have saved our application data, generate an oauth url and send
                    // our user to it!
                    window.location.href = api.generateAuthLink(data["client_id"],
                        data["redirect_uri"],
                        "code", // oauth method
                        ["read", "write", "follow"] //scopes
                    );
                }
            );} else {
				api.setConfig("api_user_token", localStorage.getItem("mastodon_token"));
			}
	</script>
	<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--fixed-tabs">
	    <header class="mdl-layout__header ttk-navbar mdl-color--white mdl-shadow--8dp">
            <!-- Tabs -->
            <div class="mdl-layout__tab-bar mdl-js-ripple-effect mdl-color--white">
              <a href="#ttk-tab-profile" class="mdl-layout__tab"><i class="material-icons ttk-icon-mid">person</i></a>
              <a href="#ttk-tab-home" class="mdl-layout__tab is-active"><i class="material-icons ttk-icon-mid">home</i></a>
              <a href="#ttk-tab-friends" class="mdl-layout__tab"><i class="material-icons ttk-icon-mid">group</i></a>
            </div>
        </header>
        <main class="vivid-wrapper mdl-layout__content">
			<div id="sysmsg" style='display:none;margin-bottom:1em' class="demo-card-square mdl-card mdl-shadow--2dp">
			  <div class="mdl-card__title ttk-card-title">
				<span class="mdl-chip mdl-chip--contact">
					<img class="mdl-chip__contact" src="https://google.com/favicon.ico" />
					<span class="mdl-chip__text">Almighty Google</span>
				</span>&nbsp;
				<span class="mdl-chip mdl-color--red">
					<span class="mdl-chip__text">System Message</span>
				</span>
			  </div>
			  <div class="mdl-card__title ttk-card-padless vivid-emo mdl-color-text--grey">
				System message
			  </div>
			  <div class="mdl-card__supporting-text">
				Welcome to Vivid Frontend! This instance uses Vivid for simplicity and aesthetic.
			  </div>
			  <div class="mdl-card__actions mdl-card--border">
				<a class="mdl-button mdl-js-button mdl-button--icon mdl-js-ripple-effect mdl-color-text--grey" id="post_like_sys" onclick="toggle_like('post_like_sys')">
				  <i class="material-icons">favorite</i>
				</a>
				<span class="mdl-layout-spacer"></span>
				<button class="mdl-button mdl-js-button mdl-button--disabled mdl-js-ripple-effect mdl-color-text--grey" disabled id="post_readmore_sys">
				  SYSTEM MSG
				</button>
			  </div>
			</div>
			<br style='display:none' /> <!--remove the system message, for now-->
			
      <section class="mdl-layout__tab-panel is-active" id="ttk-tab-home">
				<div class="page-content">
					<div id="postcard-writer" class="demo-card-square mdl-card mdl-shadow--2dp">
					  <div id="postcard-writer-title" class="mdl-card__title ttk-card-title">
							<span class="mdl-chip mdl-color--red" onclick="location.assign('login.html')">
								<span class="mdl-chip__text">You do not appear to be signed in!</span>
							</span>
					  </div>
					  <script>
					  	if (localStorage.getItem('mastodon_instance') === undefined | localStorage.getItem('mastodon_instance') === null)
						  document.getElementById("postcard-writer-title").innerHTML = 
						  	`<span class="mdl-chip mdl-color--red" onclick="location.assign('login.html')">
								<span class="mdl-chip__text">You are not signed in!<br />Click here to log in.</span>
							</span>`;
					  </script>
					  <div class="mdl-card__supporting-text ttk-card-padless">
							<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
								<label class="mdl-textfield__label" for="postbox">Post something!</label>
								<textarea class="mdl-textfield__input" type="text" rows="3" id="postbox"></textarea>
							</div>
					  </div>
					  <div class="mdl-card__actions mdl-card--border">
							<span class="mdl-layout-spacer"></span>
							<a class="mdl-button mdl-js-button mdl-button--icon mdl-js-ripple-effect mdl-color-text--grey" id="btn-refresh" onclick='document.getElementById("POSTS").innerHTML="";getall();'><i class="material-icons mdl-color-text--primary">refresh</i></a>
							<button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-color-text--blue" id="post_dopost"
							onclick='api.post("statuses", {status:$("#postbox")[0].value}, function (data) {});$("#postbox")[0].value="";document.getElementById("POSTS").innerHTML="";getall();'>
								POST
							</button>
					  </div>
					</div>
					<br />
					<script>
						api.get("accounts/verify_credentials",{},function(udat){
							document.getElementById("postcard-writer-title").innerHTML = 
							`<span class="mdl-chip__text">Post as</span>&nbsp;&nbsp;
							<img class="mdl-chip__contact" src="${udat.avatar_static}"></img>
							<span class="mdl-chip__text">${udat.display_name}</span>`;
							if (udat.bot == true) {document.getElementById("postcard-writer-title").innerHTML = document.getElementById("postcard-writer-title").innerHTML +
							`<span class="mdl-chip">
								<span class="mdl-chip__text">Bot</span>
							</span>`}});
						function getall() {var timehome = api.get("timelines/home",{},function(data){
							data.forEach(function(status){
								content = status.content.replace('class="invisible"','class="link-invis"');
								document.getElementById("POSTS").innerHTML = document.getElementById("POSTS").innerHTML +
							`
							<div class="demo-card-square mdl-card mdl-shadow--2dp" id="postcard-${status.id}>
								<div class="mdl-card__title ttk-card-title">
								<span class="mdl-chip mdl-chip--contact">
									<img class="mdl-chip__contact" src="${status.account.avatar}"></img>
									<span class="mdl-chip__text">${status.account.display_name}</span>
								</span>
								</div>
								<div class="mdl-card__supporting-text">
										${status.content}
								</div>
								<div class="mdl-card__actions mdl-card--border">
								<a class="mdl-button mdl-js-button mdl-button--icon mdl-js-ripple-effect mdl-color-text--grey" id="post_like_${status.id}" onclick="toggle_like('${status.id}')">
									<i class="material-icons">favorite</i>
								</a>
								</div>
							</div><br />
							`;console.log(status); //for debugging purposes, log each status
							if (status.favourited == true) {
								$("#post_like_"+status.id).removeClass("mdl-color-text--grey");
								$("#post_like_"+status.id).addClass("mdl-color-text--red");
							}
						})})};
						getall();
					</script>
					<span id="POSTS"></span>

					</div>
      </section>
			<section class="mdl-layout__tab-panel" id="ttk-tab-profile">
              <div class="page-content">
              	<div class="mdl-card demo-card-square mdl-shadow--2dp">
										<div class="mdl-card__title">
											Profile page
										</div>
										<div class="mdl-card__supporting-text">
											In this pre-release version, the Profile Page is not yet available.
										</div>
                </div>
              </div>
            </section>
      <section class="mdl-layout__tab-panel" id="ttk-tab-friends">
      <div class="page-content">
					<div class="mdl-card demo-card-square mdl-shadow--2dp">
							<div class="mdl-card__title">
								Friends page
							</div>
							<div class="mdl-card__supporting-text">
								In this pre-release version, the Friends Page is not yet available.<p></p>
								In a future version, this page will include events, tips, and some non-status updates from friends.
							</div>
					</div>
				<!--div class="demo-card-event demo-card-square mdl-card mdl-shadow--2dp mdl-color--red mdl-color-text--white">
				<div class="mdl-card__title mdl-card--expand">
				<span class="mdl-color-text--white">
					<em>Wade Martin</em><br />
					is holding an event<br />
					<em>Pep Rally</em><br />
					Friday, October 12, 2018<br />
					1:30pm - 2:15pm
				</span>
				</div>
				<div class="mdl-card__supporting-text mdl-color-text--white">
					Pep Rally will support our Sports Teams and sport some performances
				</div>
				<div class="mdl-card__actions mdl-card--border">
				<a class="mdl-button mdl-color-text--white mdl-js-button mdl-js-ripple-effect">
					Add to Calendar
				</a>
				</div>
			</div><br />
			
			<div class="mdl-card demo-card-square mdl-shadow--2dp">
				<div class="mdl-card__title vivid-t-nopad">
					<h4>Project Teletalk Tips</h4>
				</div>
				<div class="mdl-card__supporting-text">
					Project Teletalk is constantly evolving. These UI demos are examples of what elements of the Project Teletalk UI will look like.
				</div>
				<div class="mdl-card__actions">
					<a href="https://project.b252.gq/teletalk/" class="mdl-button mdl-js-button mdl-js-ripple-effect">More</a>
				</div>
			</div><br />
			
			<div class="mdl-card demo-card-square mdl-shadow--2dp">
				<div class="mdl-card__title vivid-t-nopad mdl-card--border">
					<h4>Stories</h4>
				</div>
				<div class="mdl-card__supporting-text">
					Stories are not yet available. Check back later!
				</div>
			</div-->
		 </div></section>
    </main>
	</div>
	<script>
		function toggle_like(ename) {
			if ($("#post_like_"+ename).hasClass("mdl-color-text--grey")) { //TODO: get ids and check the post
				//Favorite
				$("#post_like_"+ename).removeClass("mdl-color-text--grey");
				$("#post_like_"+ename).addClass("mdl-color-text--red");
				api.post("statuses/:"+ename+"/favourite");
			} else {
				//Un-favorite
				$("#post_like_"+ename).addClass("mdl-color-text--grey");
				$("#post_like_"+ename).removeClass("mdl-color-text--red");
				api.post("statuses/:"+ename+"/unfavourite");
			}
		}
	</script>
</body>
